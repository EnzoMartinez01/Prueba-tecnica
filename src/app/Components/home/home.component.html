<!-- Contenedor de los filtros -->
<div class="filter-container">
  <mat-form-field class="search-bar" appearance="fill">
    <mat-label>Buscar</mat-label>
    <input matInput [(ngModel)]="filters.searchTerm" (ngModelChange)="loadEntidad()" placeholder="Buscar...">
  </mat-form-field>

  <mat-form-field class="small-filter" appearance="fill">
    <mat-label>Tipo de Documento</mat-label>
    <mat-select [(value)]="filters.documentType" (selectionChange)="loadEntidad()">
      <mat-option value="">Todos</mat-option>
      <mat-option *ngFor="let documentType of documentTypes" [value]="documentType.id">
        {{ documentType.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field class="small-filter" appearance="fill">
    <mat-label>Tipo de Contribuyente</mat-label>
    <mat-select [(value)]="filters.contributorType" (selectionChange)="loadEntidad()">
      <mat-option value="">Todos</mat-option>
      <mat-option *ngFor="let contributorType of contributorTypes" [value]="contributorType.id">
        {{ contributorType.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field class="small-filter" appearance="fill">
    <mat-label>Estado</mat-label>
    <mat-select [(value)]="filters.active" (selectionChange)="loadEntidad()">
      <mat-option value="">Todos</mat-option>
      <mat-option [value]="true">Activo</mat-option>
      <mat-option [value]="false">Inactivo</mat-option>
    </mat-select>
  </mat-form-field>
</div>

<div *ngIf="isAddEntidadDialogOpen" class="modal-overlay">
  <div class="modal-card">
    <h3>
      Registrar Nueva Entidad
    </h3>

    <form (ngSubmit)="submitForm()">
      <div class="form-container">
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Tipo de Documento</mat-label>
            <mat-select [(value)]="newEntidad.documentType" name="documentType" required>
              <mat-option *ngFor="let documentType of documentTypes" [value]="documentType.id">
                {{ documentType.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Número de Documento</mat-label>
            <input matInput [(ngModel)]="newEntidad.documentNumber" name="documentNumber" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Razón Social</mat-label>
            <input matInput [(ngModel)]="newEntidad.socialReason" name="socialReason" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Nombre Comercial</mat-label>
            <input matInput [(ngModel)]="newEntidad.nameCommercial" name="nameCommercial" />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Tipo de Contribuyente</mat-label>
            <mat-select [(value)]="newEntidad.contributorType" name="contributorType">
              <mat-option *ngFor="let contributorType of contributorTypes" [value]="contributorType.id">
                {{ contributorType.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Dirección</mat-label>
            <input matInput [(ngModel)]="newEntidad.address" name="address" />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput [(ngModel)]="newEntidad.phone" name="phone" />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-checkbox [(ngModel)]="newEntidad.active" name="active">Activo</mat-checkbox>
        </div>
      </div>

      <div class="modal-actions">
        <button mat-raised-button color="primary" type="submit">Guardar</button>
        <button mat-raised-button color="warn" type="button" (click)="closeAddEntidadDialog()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para editar Entidad -->
<div *ngIf="isEditEntidadDialogOpen" class="modal-overlay">
  <div class="modal-card">
    <h3>Editar Entidad</h3>
    <form (ngSubmit)="submitEditForm()">
      <div class="form-container">
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Tipo de Documento</mat-label>
            <mat-select [(value)]="editEntidad.documentType" name="documentsType" required>
              <mat-option *ngFor="let documentType of documentTypes" [value]="documentType.id">
                {{ documentType.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Número de Documento</mat-label>
            <input matInput [(ngModel)]="editEntidad.documentNumber" name="documentNumber" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Razón Social</mat-label>
            <input matInput [(ngModel)]="editEntidad.socialReason" name="socialReason" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Nombre Comercial</mat-label>
            <input matInput [(ngModel)]="editEntidad.nameCommercial" name="nameCommercial" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Tipo de Contribuyente</mat-label>
            <mat-select [(value)]="editEntidad.contributorType" name="contributorType" required>
              <mat-option *ngFor="let contributorType of contributorTypes" [value]="contributorType.id">
                {{ contributorType.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Dirección</mat-label>
            <input matInput [(ngModel)]="editEntidad.address" name="address" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-form-field appearance="fill">
            <mat-label>Teléfono</mat-label>
            <input matInput [(ngModel)]="editEntidad.phone" name="phone" required />
          </mat-form-field>
        </div>
        <div class="form-item">
          <mat-checkbox [(ngModel)]="editEntidad.active" name="active">Activo</mat-checkbox>
        </div>
      </div>

      <div class="modal-actions">
        <button mat-raised-button color="primary" type="submit">Guardar Cambios</button>
        <button mat-raised-button color="warn" type="button" (click)="closeEditEntidadDialog()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Tabla de Entidades -->
<div class="table-container">
  <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
    <!-- Columnas de la tabla -->
    <ng-container matColumnDef="idEntidad">
      <th mat-header-cell *matHeaderCellDef>ID</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.idEntidad }}</td>
    </ng-container>

    <ng-container matColumnDef="socialReason">
      <th mat-header-cell *matHeaderCellDef>Razón Social</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.socialReason }}</td>
    </ng-container>

    <ng-container matColumnDef="documentTypeName">
      <th mat-header-cell *matHeaderCellDef>Nombre del Documento</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.documentTypeName }}</td>
    </ng-container>

    <ng-container matColumnDef="documentNumber">
      <th mat-header-cell *matHeaderCellDef>Número de Documento</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.documentNumber }}</td>
    </ng-container>

    <ng-container matColumnDef="contributorTypeName">
      <th mat-header-cell *matHeaderCellDef>Nombre del Contribuyente</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.contributorTypeName }}</td>
    </ng-container>

    <ng-container matColumnDef="address">
      <th mat-header-cell *matHeaderCellDef>Dirección</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.address }}</td>
    </ng-container>

    <ng-container matColumnDef="phone">
      <th mat-header-cell *matHeaderCellDef>Teléfono</th>
      <td mat-cell *matCellDef="let entidad">{{ entidad.phone }}</td>
    </ng-container>

    <ng-container matColumnDef="active">
      <th mat-header-cell *matHeaderCellDef>Estado</th>
      <td mat-cell *matCellDef="let entidad">
        <mat-icon *ngIf="entidad.active; else notActive" class="active-icon">check_circle</mat-icon>
        <ng-template #notActive>
          <mat-icon class="inactive-icon">cancel</mat-icon>
        </ng-template>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let entidad">
        <button mat-icon-button (click)="viewInfo(entidad)">
          <mat-icon>info</mat-icon>
        </button>
        <button mat-icon-button (click)="openEditEntidadDialog(entidad)">
          <mat-icon>edit</mat-icon>
        </button>
        <button *ngIf="entidad.active" mat-icon-button (click)="openDeleteConfirmDialog(entidad)">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
</div>

<br>

<div class="table-footer">
  <mat-paginator
    [length]="totalElements"
    [pageSize]="pageSize"
    [pageSizeOptions]="[5, 10, 25, 50]"
    (page)="onPaginateChange($event)">
  </mat-paginator>
  <button mat-raised-button color="primary" class="add-entity-button" (click)="openAddEntidadDialog()">Añadir Entidad</button>
</div>

<!-- Modal de confirmación de eliminación -->
<div *ngIf="isDeleteConfirmDialogOpen" class="modal-overlay">
  <div class="modal-card">
    <h3>Confirmar Eliminación</h3>
    <p>¿Estás seguro de que deseas eliminar la entidad <strong>{{ entidadToDelete?.name }}</strong>?</p>
    <div class="modal-actions">
      <button mat-raised-button color="warn" (click)="confirmDelete()">Eliminar</button>
      <button mat-raised-button color="primary" (click)="closeDeleteConfirmDialog()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Detalles del Entidad -->
<div *ngIf="selectedEntidad" class="info-card-overlay">
  <div class="info-card">
    <h3>Información de la Entidad</h3>
    <div class="info-content">
      <div class="info-column">
        <p><strong>Tipo de Documento:</strong> {{ selectedEntidad.documentTypeName }}</p>
        <p><strong>Número de Documento:</strong> {{ selectedEntidad.documentNumber }}</p>
        <p><strong>Razón Social:</strong> {{ selectedEntidad.socialReason }}</p>
        <p><strong>Nombre Comercial:</strong> {{ selectedEntidad.nameCommercial }}</p>
        <p><strong>Tipo de Contribuyente:</strong> {{ selectedEntidad.contributorTypeName }}</p>
        <p><strong>Dirección:</strong> {{ selectedEntidad.address }}</p>
        <p><strong>Teléfono:</strong> {{ selectedEntidad.phone }}</p>
        <p><strong>Estado:</strong>
          <mat-icon *ngIf="selectedEntidad.active; else notActive" class="active-icon">check_circle</mat-icon>
          <ng-template #notActive>
            <mat-icon class="inactive-icon">cancel</mat-icon>
          </ng-template>
        </p>
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="closeInfo()">Cerrar</button>
  </div>
</div>
